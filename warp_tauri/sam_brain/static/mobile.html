<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SAM</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --primary: #e94560;
            --text: #eee;
            --text-dim: #888;
            --user-bg: #0f3460;
            --sam-bg: #1f4068;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--surface);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .status {
            font-size: 12px;
            color: var(--text-dim);
        }

        .status.online { color: #4ade80; }
        .status.offline { color: var(--primary); }

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 16px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: var(--user-bg);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.sam {
            background: var(--sam-bg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.sam .sender {
            color: var(--primary);
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .message pre {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }

        .message code {
            font-family: 'SF Mono', Monaco, monospace;
        }

        .typing {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing span:nth-child(1) { animation-delay: -0.32s; }
        .typing span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        #input-area {
            background: var(--surface);
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex;
            gap: 10px;
            align-items: flex-end;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 24px;
            padding: 12px 18px;
            color: var(--text);
            font-size: 16px;
            resize: none;
            max-height: 120px;
            outline: none;
        }

        #input::placeholder {
            color: var(--text-dim);
        }

        button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, opacity 0.1s;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            opacity: 0.5;
        }

        #voice-btn {
            background: transparent;
            border: 2px solid var(--primary);
        }

        #voice-btn.recording {
            background: var(--primary);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(233, 69, 96, 0); }
        }

        .settings-btn {
            background: transparent !important;
            border: none !important;
            font-size: 24px !important;
        }

        #settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            padding: 20px;
        }

        #settings-modal.show {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .settings-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        .settings-content h2 {
            margin-top: 0;
            color: var(--primary);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .toggle {
            width: 50px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
        }

        .toggle.on {
            background: var(--primary);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle.on::after {
            transform: translateX(22px);
        }

        .close-btn {
            margin-top: 16px;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">SAM</div>
        <button class="settings-btn" onclick="toggleSettings()">&#9881;</button>
    </header>

    <div id="chat">
        <div class="message sam">
            <div class="sender">SAM</div>
            <div>Hey there. What's on your mind?</div>
        </div>
    </div>

    <div id="input-area">
        <button id="voice-btn" onclick="toggleVoice()">&#127908;</button>
        <textarea id="input" rows="1" placeholder="Message SAM..." onkeydown="handleKey(event)"></textarea>
        <button id="send-btn" onclick="sendMessage()">&#10148;</button>
    </div>

    <div id="settings-modal">
        <div class="settings-content">
            <h2>Settings</h2>
            <div class="setting-row">
                <span>Voice Output</span>
                <div class="toggle" id="voice-toggle" onclick="toggleSetting('voice')"></div>
            </div>
            <div class="setting-row">
                <span>Roleplay Mode</span>
                <div class="toggle" id="roleplay-toggle" onclick="toggleSetting('roleplay')"></div>
            </div>
            <div class="setting-row">
                <span>Status</span>
                <span class="status" id="connection-status">Checking...</span>
            </div>
            <button class="close-btn" onclick="toggleSettings()">Close</button>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let settings = {
            voice: false,
            roleplay: false
        };

        // Elements
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const voiceBtn = document.getElementById('voice-btn');
        const sendBtn = document.getElementById('send-btn');
        const statusEl = document.getElementById('connection-status');

        // Speech recognition
        let recognition = null;
        let isRecording = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (e) => {
                const transcript = Array.from(e.results)
                    .map(r => r[0].transcript)
                    .join('');
                input.value = transcript;
            };

            recognition.onend = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                if (input.value.trim()) {
                    sendMessage();
                }
            };

            recognition.onerror = () => {
                isRecording = false;
                voiceBtn.classList.remove('recording');
            };
        }

        // Speech synthesis
        function speak(text) {
            if (!settings.voice) return;

            // Try server TTS first, fallback to browser
            fetch(`${API_BASE}/api/voice/speak`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            }).catch(() => {
                // Fallback to browser TTS
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                speechSynthesis.speak(utterance);
            });
        }

        // Toggle voice recording
        function toggleVoice() {
            if (!recognition) {
                alert('Voice input not supported on this browser');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                isRecording = true;
                voiceBtn.classList.add('recording');
                recognition.start();
            }
        }

        // Send message
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // Add user message
            addMessage(text, 'user');
            input.value = '';
            autoResize();

            // Show typing indicator
            const typingEl = document.createElement('div');
            typingEl.className = 'message sam';
            typingEl.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
            chat.appendChild(typingEl);
            chat.scrollTop = chat.scrollHeight;

            try {
                const mode = settings.roleplay ? 'roleplay' : 'default';
                const response = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: text, mode })
                });

                const data = await response.json();
                typingEl.remove();

                const reply = data.response || data.result || data.error || 'No response';
                addMessage(reply, 'sam');
                speak(reply);

            } catch (err) {
                typingEl.remove();
                addMessage('Connection error. Make sure SAM is running.', 'sam');
            }
        }

        // Add message to chat
        function addMessage(text, sender) {
            const msg = document.createElement('div');
            msg.className = `message ${sender}`;

            if (sender === 'sam') {
                msg.innerHTML = `<div class="sender">SAM</div><div>${formatMessage(text)}</div>`;
            } else {
                msg.textContent = text;
            }

            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        // Format message (handle code blocks, etc.)
        function formatMessage(text) {
            // Handle code blocks
            text = text.replace(/```(\w+)?\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            // Handle inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Handle newlines
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        // Handle keyboard
        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        function autoResize() {
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
        }

        input.addEventListener('input', autoResize);

        // Toggle settings
        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('show');
        }

        function toggleSetting(setting) {
            settings[setting] = !settings[setting];
            document.getElementById(`${setting}-toggle`).classList.toggle('on', settings[setting]);
            localStorage.setItem('sam-settings', JSON.stringify(settings));
        }

        // Load settings
        const saved = localStorage.getItem('sam-settings');
        if (saved) {
            settings = JSON.parse(saved);
            document.getElementById('voice-toggle').classList.toggle('on', settings.voice);
            document.getElementById('roleplay-toggle').classList.toggle('on', settings.roleplay);
        }

        // Check connection
        async function checkConnection() {
            try {
                const res = await fetch(`${API_BASE}/api/status`, { timeout: 3000 });
                if (res.ok) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'status online';
                } else {
                    throw new Error();
                }
            } catch {
                statusEl.textContent = 'Offline';
                statusEl.className = 'status offline';
            }
        }

        checkConnection();
        setInterval(checkConnection, 30000);

        // Focus input on load
        input.focus();
    </script>
</body>
</html>
